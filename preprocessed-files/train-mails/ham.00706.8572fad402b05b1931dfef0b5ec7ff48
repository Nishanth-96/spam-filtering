thi is a multipart mime messag . -- ==_exmh_numb content-typ : text/plain ; charset=us-ascii emailaddr said : > i just check in a code cleanup which doe n't address thi issu , > but doe take a machet to code right around it . you ought to 'cv > updat ' and see if your issu becom ani clearer with all the > brush remov . > my patch note that 'msgid ' and 'line ' are redund with one > anoth and remov one or the other from function which take > both . the caller are then chang to pass what the function > expect . in the case of msg_chang , the 'line ' argument is remov > and we onli have the msgid argument . ftoc_clearcurr is now the > first line of msgchang . the follow patch remov ftoc_rescanlin in favour of a ftoc_rescanlin . it run scan ( number ) on a list of line and updat ftoc accordingli . the patch also chang all the caller to make use of it . it also chang ftoc_clearcurr to work of an argument instead of falsili clear a messag that 's still current on disk . all in an effort to get a one-to-on disk-display correspond . it doe add ~number -- ~ number ms ( ~ = > dollarf '' warn @ @ -number , number +number , number @ @ proc ftoccommit { tagnam commitproc { cop set ftoc ( displaydirti ) number ftoc_clearmsgcach if { dollarmsgid == dollarcurid } { - ftoc_clearcurr + ftoc_clearcurr dollarftoc ( curlin ) msg_clearcurr } if { dollarl == dollarftoc ( curlin ) } { index : lib/msg.tcl =================================================================== rc file : /cvsroot/exmh/exmh/lib/msg.tcl , v retriev revis number.numb diff -u -b -b -w -p -rnumber.numb msg.tcl -- - lib/msg.tcl number jul number number : number : number -number number.numb +++ lib/msg.tcl number jul number number : number : number -number @ @ -number , number +number , number @ @ proc msg_showunseen { { show show } } { return number } proc msg_clearcurr { } { - global msg exmh + global msg exmh ftoc + # are there case where thi is not true ? + if { dollarftoc ( folder ) == dollarexmh ( folder ) } { + set prevlin [ ftoc_findmsg [ mh_cur dollarftoc ( folder ) ] ] + if { dollarprevlin == { } } { + unset prevlin + } + } set msg ( id ) { } ; # clear current messag set msg ( dpi ) { } ; # and current display messag mh_clearcur dollarexmh ( folder ) + if { [ info exist prevlin ] } { + ftoc_clearcurr dollarprevlin + } msgclear buttons_curr number uri_clearcurr @ @ -number , number +number , number @ @ proc msg_chang { msgid { show show } } { exmh_debug msg_chang [ time [ list msgchang dollarmsgid dollarshow ] ] } proc msgchang { msgid { show show } } { - global exmh exwin msg mhprofil + global exmh exwin msg mhprofil ftoc - ftoc_clearcurr + set prevlin [ ftoc_findmsg [ mh_cur dollarftoc ( folder ) ] ] mh_setcur dollarexmh ( folder ) dollarmsgid ftoc_showsequ dollarexmh ( folder ) set line [ ftoc_findmsg dollarmsgid ] - if { ! [ ftoc_chang dollarlin dollarshow ] } { + if { ! [ ftoc_chang dollarlin dollarprevlin ] } { exmh_statu `` can not find msg dollarmsgid - rescan ? '' } els { if { dollarmsg ( id ) == { } } { @ @ -number , number +number , number @ @ proc msg_uudecod { } { } proc msg_markunseen { } { - global exmh + global exmh ftoc msg_checkpoint ftoc_iter line { set msgid [ ftoc_msgnumb dollarlin ] mh_markunseen dollarexmh ( folder ) dollarmsgid } - msg_clearcurr - ftoc_clearcurr + ftoc_rescanlin dollarftoc ( lineset ) + # whi wa thi need ? + # msg_clearcurr + # not need anymor + # ftoc_clearcurr flist_forgetunseen dollarexmh ( folder ) ftoc_showsequ dollarexmh ( folder ) } index : lib/scan.tcl =================================================================== rc file : /cvsroot/exmh/exmh/lib/scan.tcl , v retriev revis number.numb diff -u -b -b -w -p -rnumber.numb scan.tcl -- - lib/scan.tcl number jul number number : number : number -number number.numb +++ lib/scan.tcl number jul number number : number : number -number @ @ -number , number +number , number @ @ proc scan_cacheupd { } { # thi thing . # if ! dollarftoc ( displayvalid ) { - set curlin [ ftoc_clearcurr ] ; # clear + + ftoc_clearcurr dollarftoc ( curlin ) ; # clear + if [ file writabl dollarcachefil ] { set scancmd `` exec dollarmhprofil ( scan-proc ) [ list +dollarfold ] \ -width dollarftoc ( scanwidth ) > [ list dollarcachefil ] '' @ @ -number , number +number , number @ @ proc scan_cacheupd { } { exmh_statu `` fail to rescan folder dollarfold : dollarerr '' warn } } - ftoc_chang dollarcurlin ; # restor it + ftoc_chang dollarftoc ( curlin ) ; # restor it } elseif [ catch { set cacheio [ open dollarcachefil w ] - set curlin [ ftoc_clearcurr ] ; # clear + + ftoc_clearcurr dollarftoc ( curlin ) ; # clear + set display [ dollarexwin ( ftext ) get number.numb `` end -number char '' ] - ftoc_chang dollarcurlin ; # restor it + ftoc_chang dollarftoc ( curlin ) ; # restor it put dollarcacheio dollardisplay nonewlin close dollarcacheio set ftoc ( displaydirti ) number -- ==_exmh_numb -- _______________________________________________ exmh-work mail list emailaddr httpaddr